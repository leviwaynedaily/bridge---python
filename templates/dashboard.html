<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tailgating Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans:wght@600&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: hidden;
        }
        body {
            min-height: 100vh;
            background: #000000;
            color: #FFFFFF;
            font-family: 'Montserrat', 'Open Sans', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #main-content {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .container {
            max-width: 100%;
            margin: 0;
            padding: 18px 18px 0 18px;
            background: #000;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex: 1 1 auto;
            height: 100%;
            overflow: hidden;
        }
        h1 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5em;
            letter-spacing: 0.18em;
            color: #FFFFFF;
            text-transform: uppercase;
            text-align: left;
            margin-top: 0.5em;
        }
        .event-log {
            margin-top: 0.5em;
            flex: 1 1 auto;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
            border-radius: 0;
            background: #000000;
            position: relative;
            padding-left: 0;
            padding-right: 0;
            z-index: 1;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: #000000;
            border-radius: 0;
        }
        th, td {
            padding: 3px 4px;
            text-align: left;
            font-size: 1em;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        td.count-col {
            text-align: right;
        }
        td.device-col, td.event-col {
            max-width: 90px;
        }
        th {
            background: #000000 !important;
            background-clip: padding-box;
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.12);
            color: #5CE1E6;
            font-size: 0.98em;
            font-weight: 600;
            border-bottom: 2px solid #5CE1E6;
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: left;
        }
        tr {
            border-bottom: 1px solid #333;
        }
        tr:last-child {
            border-bottom: none;
        }
        tr:hover {
            background: #111;
        }
        td {
            color: #FFFFFF;
            font-size: 0.95em;
        }
        td.tailgate {
            color: #FF3333 !important;
            font-weight: bold !important;
            background: #000000;
            border-radius: 4px;
            padding: 4px 8px;
        }
        td.no-tailgate {
            color: #00FF66 !important;
            font-weight: bold;
            background: #000000;
            border-radius: 4px;
            padding: 4px 8px;
        }
        .ignored {
            color: #888;
            font-style: italic;
        }
        .gauges-sticky {
            position: sticky;
            top: 0;
            z-index: 5;
            background: #000000;
            padding: 6px 2px 4px 2px;
        }
        #gauges-row {
            display: flex;
            gap: 10px;
            margin-bottom: 0.5em;
            flex-wrap: wrap;
            padding: 0 2px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .gauge-card {
            flex: 1 1 100px;
            min-width: 80px;
            background: #181818;
            border-radius: 10px;
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
            border: none;
            transition: background 0.2s;
            margin-bottom: 8px;
            margin-left: 2px;
            margin-right: 2px;
            box-sizing: border-box;
        }
        .gauge-card.people {
            cursor: default;
            border: none;
            background: #181818;
        }
        .gauge-card.selectable {
            cursor: pointer;
        }
        .gauge-card.selectable:hover {
            border: 2.5px solid #fff;
            background: #101010;
        }
        .gauge-card.selected {
            border: 2.5px solid #5CE1E6 !important;
        }
        .gauge-label {
            font-size: 0.85em;
            color: #5CE1E6;
            margin-bottom: 2px;
            letter-spacing: 0.02em;
            text-align: left;
            font-weight: 600;
        }
        .gauge-num {
            font-size: 2.2em;
            font-weight: bold;
            text-align: left;
            color: #fff;
        }
        .gauge-card .gauge-num.red {
            color: #FF3333;
        }
        .gauge-card .gauge-num.white {
            color: #fff;
        }
        .gauge-desc {
            font-size: 0.78em;
            color: #B0B0B0;
            margin-top: 2px;
            margin-bottom: 2px;
            font-weight: 400;
            opacity: 1;
            display: block;
        }
        .gauge-info-icon {
            position: absolute;
            top: 14px;
            right: 16px;
            width: 12px;
            height: 12px;
            background: #444;
            border-radius: 50%;
            border: 1px solid #888;
            color: #ccc;
            font-size: 0.7em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s, color 0.2s, border 0.2s;
            padding-right: 2px;
        }
        .gauge-info-icon:hover {
            background: #666;
            color: #fff;
            border: 1px solid #bbb;
        }
        .gauge-tooltip {
            display: none;
        }
        .gauge-card.show-tooltip .gauge-tooltip {
            display: block;
        }
        @media (min-width: 1101px) {
            .gauge-info-icon, .gauge-tooltip { display: none !important; }
        }
        @media (max-width: 1100px) {
            .gauge-desc { display: none; }
            .gauge-info-icon { display: flex; }
        }
        @media (max-width: 700px) {
            .container { padding: 10px; overflow-x: hidden; height: 100%; }
            table, th, td { font-size: 0.90em; }
            .gauges-sticky { padding: 2px 0 1px 0; }
            #gauges-row {
                flex-direction: column;
                gap: 4px;
                padding: 0 0;
                width: 100%;
                overflow-x: hidden;
            }
            .gauge-card {
                min-width: 0;
                width: 100%;
                margin-left: 0;
                margin-right: 0;
                padding: 2px 8px 6px 8px;
                box-sizing: border-box;
            }
            .gauge-label {
                font-size: 0.7em;
                margin-bottom: 0;
            }
            .gauge-num {
                font-size: 1.6em;
            }
            .event-log {
                margin-top: 0.3em;
                height: 100%;
                padding-left: 0;
                padding-right: 0;
            }
        }
        @media (max-width: 900px) {
            th.time-col, td.time-col {
                min-width: 70px;
                max-width: 90px;
            }
            th, td, .event-log {
                font-size: 0.92em !important;
            }
            th.source-col, td.source-col {
                display: none !important;
            }
        }
        /* Settings Modal Customizations */
        #settings-modal h2 {
            color: #fff !important;
            text-transform: uppercase;
            font-family: 'Montserrat', 'Open Sans', Arial, sans-serif;
            font-weight: 600;
            letter-spacing: 0.08em;
        }
        #settings-modal label {
            color: #fff;
            font-family: 'Montserrat', 'Open Sans', Arial, sans-serif;
            text-transform: none;
        }
        #settings-modal input[type="text"],
        #settings-modal input[type="password"],
        #settings-modal input[type="number"] {
            background: #000000;
            color: #5CE1E6;
            border: 1px solid #5CE1E6;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 1em;
            font-family: 'Montserrat', 'Open Sans', Arial, sans-serif;
        }
        #settings-modal button,
        #settings-modal button[type="button"],
        #settings-modal button[type="submit"] {
            background: transparent !important;
            color: #5CE1E6 !important;
            border: 2px solid #5CE1E6 !important;
            border-radius: 4px;
            padding: 8px 18px;
            font-weight: bold;
            font-family: 'Montserrat', 'Open Sans', Arial, sans-serif;
            font-size: 1em;
            margin-bottom: 8px;
            margin-right: 8px;
            transition: background 0.2s, color 0.2s;
            box-shadow: none;
            outline: none;
            cursor: pointer;
        }
        #settings-modal button:hover,
        #settings-modal button:focus {
            background: #5CE1E6 !important;
            color: #1B1B1B !important;
        }
        #settings-modal #close-settings {
            color: #fff !important;
            border: none !important;
            background: none !important;
            font-size: 1.5em;
            margin: 0;
            padding: 0;
        }
        #settings-modal #close-settings:hover {
            color: #5CE1E6 !important;
        }
        #settings-modal #window-status-modal,
        #settings-modal #netbox-test-status-modal {
            color: #5CE1E6 !important;
        }
        #settings-modal #test-status-modal {
            color: #5CE1E6 !important;
        }
        .event-log, table, th, td {
            font-family: 'Segoe UI', 'Arial', 'Helvetica Neue', Arial, sans-serif !important;
            color: #C7C7C7 !important;
            font-size: 1em !important;
        }
        /* Sidebar Modernization */
        #sidebar, #sidebar label, #sidebar input, #sidebar button, #sidebar form, #sidebar span {
            font-family: 'Segoe UI', 'Arial', 'Helvetica Neue', Arial, sans-serif !important;
            font-size: 0.93em !important;
            color: #C7C7C7 !important;
        }
        #sidebar label {
            font-weight: 500;
            letter-spacing: 0.01em;
            margin-bottom: 4px;
        }
        #sidebar input[type="text"], #sidebar input[type="password"], #sidebar input[type="number"] {
            background: #181818;
            color: #5CE1E6;
            border: 1px solid #5CE1E6;
            border-radius: 4px;
            padding: 3px 7px;
            font-size: 0.93em;
            margin-bottom: 8px;
        }
        #sidebar button {
            background: #181818 !important;
            color: #fff !important;
            border: 2px solid #5CE1E6 !important;
            border-radius: 18px !important;
            padding: 6px 14px !important;
            font-weight: 600;
            font-size: 0.93em !important;
            margin-bottom: 7px;
            margin-right: 7px;
            transition: background 0.2s, color 0.2s;
            box-shadow: none;
            outline: none;
            cursor: pointer;
        }
        #sidebar button:hover, #sidebar button:focus {
            background: #5CE1E6 !important;
            color: #181818 !important;
        }
        #sidebar button:active {
            background: #5CE1E6 !important;
            color: #181818 !important;
        }
        /* Modern slider switch for Netbox enable */
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
            margin-right: 12px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444;
            transition: .3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #5CE1E6;
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .switch-label {
            font-size: 1em;
            font-weight: 500;
            margin-right: 8px;
        }
        .switch-status {
            font-size: 1em;
            font-weight: 600;
            margin-left: 10px;
            color: #5CE1E6;
        }
        /* Modal-style tooltip popup */
        #center-tooltip-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #232323;
            color: #B0B0B0;
            font-size: 0.98em;
            padding: 28px 36px;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.32);
            max-width: 400px;
            min-width: 220px;
            z-index: 1001;
            text-align: left;
            line-height: 1.5;
            pointer-events: auto;
        }
        #center-tooltip-modal.show {
            display: block;
        }
        #center-tooltip-modal-close {
            position: absolute;
            top: 10px;
            right: 18px;
            color: #aaa;
            background: none;
            border: 2px solid #5CE1E6;
            border-radius: 5px;
            font-size: 1.5em;
            cursor: pointer;
            z-index: 1002;
            pointer-events: auto;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #center-tooltip-modal-close:hover {
            background: #333;
            color: #fff;
            border-color: #fff;
        }
        #center-tooltip-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.45);
            z-index: 1000;
            pointer-events: auto;
        }
        #center-tooltip-overlay.show {
            display: block;
        }
    </style>
    <script>
        let eventFilter = null; // 'linecross' | 'tailgate' | null
        function renderGauges(events, peopleCount) {
            let lineCrossCount = 0;
            let tailgateCount = 0;
            for (let e of events) {
                if (e.type === 'camera' && e.event && e.event.toLowerCase().includes('linecross')) lineCrossCount++;
                if (e.verdict && (e.verdict.toUpperCase() === 'TAILGATING' || e.verdict.toUpperCase() === 'TAILGATE')) tailgateCount++;
            }
            document.getElementById('gauge-linecross-num').textContent = lineCrossCount;
            document.getElementById('gauge-tailgate-num').textContent = tailgateCount;
            document.getElementById('gauge-people-num').textContent = peopleCount;
            // Tailgating gauge color logic
            let tailgateNum = document.getElementById('gauge-tailgate-num');
            if (tailgateCount > 0) {
                tailgateNum.style.color = '#FF3333';
            } else {
                tailgateNum.style.color = '#fff';
            }
        }
        function showReconnectMsg(show) {
            let msg = document.getElementById('reconnect-msg');
            if (!msg) {
                msg = document.createElement('div');
                msg.id = 'reconnect-msg';
                msg.style = 'color:#FF3333; background:#232323; text-align:center; padding:8px 0; font-size:1.1em; font-family:inherit; border-radius:8px; margin-bottom:8px;';
                let container = document.querySelector('.event-log');
                if (container && container.parentNode) {
                    container.parentNode.insertBefore(msg, container);
                }
            }
            msg.textContent = show ? 'Reconnecting to server...' : '';
            msg.style.display = show ? '' : 'none';
        }
        function formatDateLabel(dateStr) {
            let dt = new Date(dateStr);
            if (isNaN(dt.getTime())) return 'Invalid Date';
            let now = new Date();
            let today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let eventDay = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            let diffDays = Math.floor((today - eventDay) / (1000*60*60*24));
            let timeStr = dt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
            let label = '';
            if (diffDays === 0) {
                label = `Today @ ${timeStr}`;
            } else if (diffDays === 1) {
                label = `Yesterday @ ${timeStr}`;
            } else if (diffDays < 7) {
                // Show weekday (short) and time
                let weekday = dt.toLocaleDateString([], { weekday: 'short' });
                label = `${weekday} @ ${timeStr}`;
            } else {
                // Show month (short), day, and time
                let monthDay = dt.toLocaleDateString([], { month: 'short', day: 'numeric' });
                label = `${monthDay} @ ${timeStr}`;
            }
            return label;
        }
        function fetchEvents() {
            fetch('/events').then(r => r.json()).then(data => {
                showReconnectMsg(false);
                let events = data.events || [];
                let peopleCount = data.people_count || 0;
                let windowVal = data.window || 4;
                if (document.getElementById('window-input')) {
                    document.getElementById('window-input').value = windowVal;
                }
                if (document.getElementById('window-input-modal')) {
                    document.getElementById('window-input-modal').value = windowVal;
                }
                renderGauges(events, peopleCount);
                // Render events (with filter)
                let tbody = document.getElementById('event-tbody');
                tbody.innerHTML = '';
                let filtered = events;
                if (eventFilter === 'linecross') {
                    filtered = events.filter(e => e.type === 'camera' && e.event && e.event.toLowerCase().includes('linecross'));
                } else if (eventFilter === 'tailgate') {
                    filtered = events.filter(e => e.verdict && e.verdict.toUpperCase() === 'TAILGATING');
                }
                for (let e of filtered) {
                    let row = document.createElement('tr');
                    let timeCellFull = formatDateLabel(e.time);
                    // Responsive: show only time for today on medium/small screens
                    let isToday = false;
                    let dt = new Date(e.time);
                    let now = new Date();
                    if (!isNaN(dt.getTime())) {
                        let today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        let eventDay = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
                        isToday = (today.getTime() === eventDay.getTime());
                    }
                    let timeOnly = dt.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
                    let timeCell = timeCellFull;
                    if (window.innerWidth <= 1100 && isToday) {
                        timeCell = timeOnly;
                    }
                    // Clean up count: extract leading number
                    let countVal = '';
                    if (e.count) {
                        let match = e.count.match(/(\d+)/);
                        countVal = match ? match[1] : e.count;
                    }
                    // Clean up event: add space in 'TailgateDetected'
                    let eventVal = e.event ? e.event.replace(/([a-z])([A-Z])/g, '$1 $2') : '';
                    // Debug: log the verdict value
                    console.log('Verdict value:', e.verdict);
                    let verdictClass = (e.verdict && (e.verdict.toUpperCase() === 'TAILGATING' || e.verdict.toUpperCase() === 'TAILGATE')) ? 'tailgate' : (e.verdict && e.verdict.toUpperCase() === 'NO TAILGATE' ? 'no-tailgate' : (e.verdict === 'IGNORED' ? 'ignored' : ''));
                    let verdictContent = e.verdict;
                    if (e.verdict && (e.verdict.toUpperCase() === 'TAILGATING' || e.verdict.toUpperCase() === 'TAILGATE')) {
                        verdictContent = `<span style=\"color:#FF3333;font-weight:bold;\">${e.verdict}</span>`;
                    } else if (e.verdict && e.verdict.toUpperCase() === 'NO TAILGATE') {
                        verdictContent = `<span style=\"color:#00FF66;font-weight:bold;\">${e.verdict}</span>`;
                    }
                    if (e.type === 'access') {
                        let source = 'Netbox';
                        let eventDesc = (e.desc && e.desc.toLowerCase().includes('unlock')) ? 'Door Unlocked' : (e.desc && e.desc.toLowerCase().includes('lock')) ? 'Door Locked' : e.desc;
                        row.innerHTML = `<td class='time-col'>${timeCell}</td><td class='type-col'>Access</td><td class='device-col' title='Test Door'>Test Door</td><td class='source-col'>${source}</td><td class='event-col' title='${eventDesc}'>${eventDesc}</td><td class='count-col'></td><td></td><td></td>`;
                    } else {
                        let source = (e.camera && e.camera === 'TestCam') ? 'Piko' : 'Simulator';
                        let eventName = (eventVal && eventVal === 'Tailgate Detected') ? 'Tailgating Analytic' : eventVal;
                        let cameraName = (e.camera && e.camera === 'TestCam') ? 'Test Camera' : e.camera;
                        row.innerHTML = `<td class='time-col'>${timeCell}</td><td class='type-col'>Camera</td><td class='device-col' title='${cameraName}'>${cameraName}</td><td class='source-col'>${source}</td><td class='event-col' title='${eventName}'>${eventName}</td><td class='count-col'>${countVal}</td><td class='${verdictClass}'>${verdictContent}</td><td></td>`;
                    }
                    tbody.appendChild(row);
                }
            }).catch(() => {
                showReconnectMsg(true);
            });
        }
        setInterval(fetchEvents, 2000);
        window.onload = function() {
            fetchEvents();
            // Gauge click handlers
            document.getElementById('gauge-linecross').onclick = function() {
                if (eventFilter === 'linecross') {
                    eventFilter = null;
                    this.classList.remove('selected');
                } else {
                    eventFilter = 'linecross';
                    this.classList.add('selected');
                    document.getElementById('gauge-tailgate').classList.remove('selected');
                }
                fetchEvents();
            };
            document.getElementById('gauge-tailgate').onclick = function() {
                if (eventFilter === 'tailgate') {
                    eventFilter = null;
                    this.classList.remove('selected');
                } else {
                    eventFilter = 'tailgate';
                    this.classList.add('selected');
                    document.getElementById('gauge-linecross').classList.remove('selected');
                }
                fetchEvents();
            };
            // Modal close logic
            document.getElementById('center-tooltip-modal-close').onclick = function(e) {
                e.stopPropagation();
                document.getElementById('center-tooltip-modal').classList.remove('show');
                document.getElementById('center-tooltip-overlay').classList.remove('show');
            };
            document.getElementById('center-tooltip-overlay').onclick = function(e) {
                if (e.target === this) {
                    document.getElementById('center-tooltip-modal').classList.remove('show');
                    document.getElementById('center-tooltip-overlay').classList.remove('show');
                }
            };
        };
        function toggleGaugeTooltip(icon) {
            const card = icon.closest('.gauge-card');
            if (card.classList.contains('show-tooltip')) {
                card.classList.remove('show-tooltip');
            } else {
                document.querySelectorAll('.gauge-card.show-tooltip').forEach(c => c.classList.remove('show-tooltip'));
                card.classList.add('show-tooltip');
            }
        }
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('gauge-info-icon')) {
                document.querySelectorAll('.gauge-card.show-tooltip').forEach(c => c.classList.remove('show-tooltip'));
            }
        });
        function showCenterTooltipModal(event) {
            if (event) event.stopPropagation();
            var modal = document.getElementById('center-tooltip-modal');
            var overlay = document.getElementById('center-tooltip-overlay');
            var content = document.getElementById('center-tooltip-modal-content');
            // Use the same tooltip text as before
            content.innerHTML = "Tailgating is flagged if people detected (always 2+) exceeds valid unlocks in the set window. Unlocks are used up as matched. Rule can be changed in settings.";
            modal.classList.add('show');
            overlay.classList.add('show');
        }
    </script>
</head>
<body>
    <!-- Hamburger and Title Row -->
    <div style="display: flex; align-items: center; margin-bottom: 0.2em; padding-top: 8px;">
        <button id="sidebar-hamburger" style="background: none; border: none; cursor: pointer; font-size: 1.2em; color: #5CE1E6; margin-right: 8px; padding: 0 2px; line-height: 1;">
            <span title="Menu">&#9776;</span>
        </button>
        <h1 style="margin: 0; padding: 0;">TAILGATING</h1>
    </div>
    <!-- Sidebar -->
    <div id="sidebar-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:100;"></div>
    <div id="sidebar" style="display:none; position:fixed; top:0; left:0; height:100vh; width:340px; max-width:90vw; background:#232323; color:#fff; z-index:102; box-shadow:2px 0 24px rgba(0,0,0,0.4); padding:0; transition: transform 0.2s;">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:24px 24px 0 24px;">
            <span style="font-size:1.5em; font-family:'Montserrat','Open Sans',Arial,sans-serif; letter-spacing:0.08em; text-transform:uppercase;">Settings</span>
            <button id="sidebar-close" style="background:none; border:none; color:#5CE1E6; font-size:2em; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:24px;">
            <div id="window-bar-sidebar" style="margin-bottom: 1.5em; font-size: 1.2em;">
                <label style="display:block; margin-bottom:8px;">Tailgate Detection Window (seconds):</label>
                <input type="number" id="window-input-sidebar" min="1" max="60" style="width:60px;">
                <button id="window-save-sidebar">Save</button>
                <span id="window-status-sidebar" style="margin-left:1em;"></span>
            </div>
            <div id="tailgate-rule-bar-sidebar" style="margin-bottom: 1.5em; font-size: 1.2em;">
                <label style="display:block; margin-bottom:8px;">Tailgating Rule:</label>
                <select id="tailgate-rule-select-sidebar" style="width:100%; margin-bottom:8px;">
                    <option value="gte">People must be less than or equal to unlocks (default)</option>
                    <option value="gt">People must be less than unlocks</option>
                </select>
                <span style="font-size:0.95em; color:#aaa;">This controls how tailgating is detected. Default: people ≤ unlocks.</span>
            </div>
            <div id="netbox-config-sidebar" style="margin-bottom: 1.5em; font-size: 1.2em;">
                <div style="margin-bottom: 18px; display: flex; align-items: center;">
                    <span class="switch-label">Netbox</span>
                    <label class="switch">
                        <input type="checkbox" id="netbox-enable-toggle">
                        <span class="slider"></span>
                    </label>
                    <span id="netbox-enable-status" class="switch-status"></span>
                </div>
                <form id="netbox-edit-form-sidebar" style="display:none;">
                    <label style="display:block; margin-bottom:8px;">NetBox URL:</label>
                    <input type="text" id="netbox-url-edit-sidebar" style="width:100%; margin-bottom:12px;">
                    <label style="display:block; margin-bottom:8px;">User:</label>
                    <input type="text" id="netbox-user-edit-sidebar" style="width:100%; margin-bottom:12px;">
                    <label style="display:block; margin-bottom:8px;">Pass:</label>
                    <input type="password" id="netbox-pass-edit-sidebar" style="width:100%; margin-bottom:12px;">
                    <div style="margin-bottom:12px;">
                        <button type="button" id="test-netbox-btn-sidebar">Test Connection</button>
                        <button type="submit">Save</button>
                        <span id="netbox-test-status-sidebar" style="margin-left:1em;"></span>
                    </div>
                </form>
            </div>
            <div id="test-buttons-bar-sidebar" style="margin-bottom: 1.5em; font-size: 1.2em; display:flex; flex-direction:column; gap:10px;">
                <button id="test-unlock-btn-sidebar">Test Door Unlock</button>
                <button id="test-lock-btn-sidebar">Test Door Lock</button>
                <button id="test-linecross-btn-sidebar">Test Line Crossing</button>
                <button id="test-tailgate-btn-sidebar">Test Tailgating</button>
                <span id="test-status-sidebar" style="margin-left:1em;"></span>
            </div>
            <div style="flex:1 1 auto;"></div>
            <div id="restart-bar-sidebar" style="margin-top:32px; display:flex; flex-direction:column; align-items:center;">
                <button id="restart-server-btn-sidebar" style="border:2px solid #5CE1E6; color:#5CE1E6; background:transparent; font-family:'Montserrat','Open Sans',Arial,sans-serif; font-size:1.1em; font-weight:bold; border-radius:4px; padding:10px 24px; margin-top:12px; width:90%; transition:background 0.2s, color 0.2s;">Restart Server</button>
                <span id="restart-status-sidebar" style="margin-top:8px; color:#5CE1E6;"></span>
                <button id="clear-db-btn-sidebar" style="border:2px solid #FF3333; color:#FF3333; background:transparent; font-family:'Montserrat','Open Sans',Arial,sans-serif; font-size:1.1em; font-weight:bold; border-radius:4px; padding:10px 24px; margin-top:16px; width:90%; transition:background 0.2s, color 0.2s;">Clear Database</button>
                <span id="clear-db-status-sidebar" style="margin-top:8px; color:#FF3333;"></span>
            </div>
        </div>
    </div>
    <div id="main-content">
      <div class="container">
        <div class="gauges-sticky">
          <div id="gauges-row">
            <div class="gauge-card people" data-desc="Number of people currently detected in the monitored area. Piko only triggers for 2 or more people crossing the line.">
              <span class="gauge-info-icon" onclick="toggleGaugeTooltip(this)">i</span>
              <span class="gauge-tooltip">Number of people currently detected in the monitored area. <b>Note:</b> Piko only triggers for 2 or more people crossing the line at once.</span>
              <span class="gauge-label">CURRENT PEOPLE COUNT</span>
              <span class="gauge-desc">Number of people currently detected in the monitored area. Piko only triggers for 2+ people.</span>
              <span id="gauge-people-num" class="gauge-num">0</span>
            </div>
            <div id="gauge-linecross" class="gauge-card selectable" data-desc="Total line crossing events detected by the camera.">
              <span class="gauge-info-icon" onclick="toggleGaugeTooltip(this)">i</span>
              <span class="gauge-tooltip">Total line crossing events detected by the camera.</span>
              <span class="gauge-label">LINE CROSSINGS</span>
              <span class="gauge-desc">Total line crossing events detected by the camera.</span>
              <span id="gauge-linecross-num" class="gauge-num white">0</span>
            </div>
            <div id="gauge-tailgate" class="gauge-card selectable" data-desc="Number of tailgating violations (more people than valid access events).">
              <span class="gauge-info-icon" onclick="showCenterTooltipModal(event)">i</span>
              <span class="gauge-tooltip">Tailgating is flagged if people detected (always 2+) exceeds valid unlocks in the set window. Unlocks are used up as matched. Rule can be changed in settings.</span>
              <span class="gauge-label">TAILGATING HISTORY</span>
              <span class="gauge-desc">Number of tailgating violations (more people than valid access events).</span>
              <span id="gauge-tailgate-num" class="gauge-num red">0</span>
            </div>
          </div>
        </div>
        <div id="window-bar" style="display:none;"></div>
        <div id="netbox-config-display" style="display:none;"></div>
        <div id="test-buttons-bar" style="display:none;"></div>
        <div class="event-log">
          <table>
            <thead>
              <tr>
                <th class="time-col">Time</th><th class="type-col">Type</th><th>Name</th><th class="source-col">Source</th><th>Event</th><th class="count-col">Count</th><th>Verdict</th><th></th>
              </tr>
            </thead>
            <tbody id="event-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Modal tooltip for center screen -->
    <div id="center-tooltip-overlay"></div>
    <div id="center-tooltip-modal">
        <button id="center-tooltip-modal-close" title="Close">&times;</button>
        <div id="center-tooltip-modal-content"></div>
    </div>
    <script>
        // Sidebar logic
        function openSidebar() {
            document.getElementById('sidebar').style.display = '';
            document.getElementById('sidebar-overlay').style.display = '';
            // Sync sidebar fields with current values
            fetch('/events').then(r => r.json()).then(data => {
                let windowVal = data.window || 4;
                document.getElementById('window-input-sidebar').value = windowVal;
            });
            fetch('/get_netbox_config').then(r => r.json()).then(cfg => {
                document.getElementById('netbox-url-edit-sidebar').value = cfg.url;
                document.getElementById('netbox-user-edit-sidebar').value = cfg.username;
                document.getElementById('netbox-pass-edit-sidebar').value = (cfg.password && cfg.password.length > 0) ? '*******' : '';
                document.getElementById('netbox-test-status-sidebar').textContent = '';
                document.getElementById('netbox-enable-toggle').checked = !!cfg.enabled;
                document.getElementById('netbox-enable-status').textContent = cfg.enabled ? 'Enabled' : 'Disabled';
                document.getElementById('netbox-edit-form-sidebar').style.display = cfg.enabled ? 'block' : 'none';
            });
        }
        function closeSidebar() {
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('sidebar-overlay').style.display = 'none';
        }
        document.getElementById('sidebar-hamburger').onclick = openSidebar;
        document.getElementById('sidebar-close').onclick = closeSidebar;
        document.getElementById('sidebar-overlay').onclick = closeSidebar;
        // Sidebar window save
        document.getElementById('window-save-sidebar').onclick = function() {
            let newWindow = parseInt(document.getElementById('window-input-sidebar').value);
            fetch('/set_window', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ window: newWindow })
            }).then(r => r.json()).then(data => {
                let status = document.getElementById('window-status-sidebar');
                if (data.status === 'ok') {
                    status.textContent = 'Saved!';
                    setTimeout(() => status.textContent = '', 2000);
                } else {
                    status.textContent = data.message || 'Error';
                }
            });
        };
        // Sidebar NetBox test
        document.getElementById('test-netbox-btn-sidebar').onclick = function() {
            let url = document.getElementById('netbox-url-edit-sidebar').value;
            let username = document.getElementById('netbox-user-edit-sidebar').value;
            let password = document.getElementById('netbox-pass-edit-sidebar').value;
            document.getElementById('netbox-test-status-sidebar').textContent = 'Testing...';
            fetch('/test_netbox', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, username, password })
            }).then(r => r.json()).then(data => {
                if (data.status === 'ok') {
                    document.getElementById('netbox-test-status-sidebar').textContent = 'Success!';
                    document.getElementById('netbox-test-status-sidebar').style.color = '#5CE1E6';
                } else {
                    document.getElementById('netbox-test-status-sidebar').textContent = data.message || 'Error';
                    document.getElementById('netbox-test-status-sidebar').style.color = '#FF3333';
                }
            }).catch(() => {
                document.getElementById('netbox-test-status-sidebar').textContent = 'Error';
                document.getElementById('netbox-test-status-sidebar').style.color = '#FF3333';
            });
        };
        // Sidebar NetBox save
        document.getElementById('netbox-edit-form-sidebar').onsubmit = function(e) {
            e.preventDefault();
            let url = document.getElementById('netbox-url-edit-sidebar').value;
            let username = document.getElementById('netbox-user-edit-sidebar').value;
            let password = document.getElementById('netbox-pass-edit-sidebar').value;
            let netboxEnabled = document.getElementById('netbox-enable-toggle').checked;
            fetch('/set_netbox_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url, username, password, enabled: netboxEnabled })
            }).then(r => r.json()).then(data => {
                closeSidebar();
                document.getElementById('netbox-pass-edit-sidebar').value = password;
            });
        };
        // Sidebar NetBox enable toggle
        document.getElementById('netbox-enable-toggle').onchange = function() {
            let enabled = this.checked;
            document.getElementById('netbox-enable-status').textContent = enabled ? 'Enabled' : 'Disabled';
            document.getElementById('netbox-edit-form-sidebar').style.display = enabled ? 'block' : 'none';
        };
        // Sidebar test buttons
        function showTestStatusSidebar(msg, color) {
            let el = document.getElementById('test-status-sidebar');
            el.textContent = msg;
            el.style.color = color;
            setTimeout(() => { el.textContent = ''; }, 2000);
        }
        document.getElementById('test-unlock-btn-sidebar').onclick = function() {
            fetch('/test_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ desc: 'Door Unlock' })
            }).then(r => r.json()).then(data => {
                showTestStatusSidebar('Door Unlock sent!', '#5CE1E6');
                fetchEvents();
            });
        };
        document.getElementById('test-lock-btn-sidebar').onclick = function() {
            fetch('/test_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ desc: 'Door Lock' })
            }).then(r => r.json()).then(data => {
                showTestStatusSidebar('Door Lock sent!', '#5CE1E6');
                fetchEvents();
            });
        };
        document.getElementById('test-linecross-btn-sidebar').onclick = function() {
            fetch('/camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ EventType: 'LineCrossing', CameraName: 'TestCam', EventName: 'LineCrossed', EventCaption: '1 person' })
            }).then(r => r.json()).then(data => {
                showTestStatusSidebar('Line Crossing sent!', '#5CE1E6');
                fetchEvents();
            });
        };
        document.getElementById('test-tailgate-btn-sidebar').onclick = function() {
            fetch('/camera', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ EventType: 'Tailgating', CameraName: 'TestCam', EventName: 'TailgateDetected', EventCaption: '2 persons', EventDescription: 'Two people passed within 10s' })
            }).then(r => r.json()).then(data => {
                showTestStatusSidebar('Tailgating sent!', '#5CE1E6');
                fetchEvents();
            });
        };
        // Sidebar restart server
        document.getElementById('restart-server-btn-sidebar').onclick = function() {
            if (!confirm('Are you sure you want to restart the server?')) return;
            document.getElementById('restart-status-sidebar').textContent = 'Restarting...';
            fetch('/restart', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('restart-status-sidebar').textContent = data.status === 'ok' ? 'Restarted!' : (data.message || 'Error');
                })
                .catch(() => {
                    document.getElementById('restart-status-sidebar').textContent = 'Error';
                });
        };
        // Sidebar clear database
        document.getElementById('clear-db-btn-sidebar').onclick = function() {
            if (!confirm('Are you sure you want to clear ALL events?')) return;
            document.getElementById('clear-db-status-sidebar').textContent = 'Clearing...';
            fetch('/clear_db', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('clear-db-status-sidebar').textContent = data.status === 'ok' ? 'Database cleared!' : (data.message || 'Error');
                    setTimeout(() => document.getElementById('clear-db-status-sidebar').textContent = '', 2000);
                    fetchEvents();
                })
                .catch(() => {
                    document.getElementById('clear-db-status-sidebar').textContent = 'Error';
                });
        };
    </script>
</body>
</html>